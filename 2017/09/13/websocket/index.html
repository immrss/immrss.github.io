<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><title>Simons</title><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link href="/css/bootstrap.min.css" rel="stylesheet"><link href="/css/font-awesome.min.css" rel="stylesheet"><link href="/css/main.css" rel="stylesheet"></head><body><div class="wrap"><nav class="page-navigation"><div class="nav-container"><div class="page-header-logo"><h1 class="prince-log"><a href="/" class="home-link">Simon</a></h1></div><button type="button" data-toggle="collapse" data-target=".main-nav-items" class="navbar-toggle"><span class="sr-only">Toggle navigation</span><span class="icon-bar"></span><span class="icon-bar"></span><span class="icon-bar"></span></button><ul class="collapse navbar-collapse main-nav-items"><li class="menu-item"><a href="/" target="_self">HOME</a></li><li class="menu-item"><a href="/archives/" target="_self">ARCHIVE</a></li><li class="menu-item"><a href="/about/" target="_self">ABOUT</a></li></ul></div></nav><main class="prince-container"><div class="post"><article class="post-block"><h1 class="post-title">Websocket原理与实践</h1><div class="post-info">Sep 13th 2017</div><div class="post-entry"><p><img src="/2017/09/13/websocket/logo.jpg" alt=""></p>
<h3 id="客户端向服务端发送握手信息"><a href="#客户端向服务端发送握手信息" class="headerlink" title="客户端向服务端发送握手信息"></a>客户端向服务端发送握手信息</h3><ol>
<li>握手必须是一个有效的HTTP请求</li>
<li>请求方法必须是<code>GET</code>，HTTP版本至少是<code>1.1</code></li>
<li></li>
<li>请求必须有<code>Host</code>头字段，它的值是<code>host:port</code></li>
<li>请求必须有一个<code>Upgrade</code>头字段，它的值必须是<code>websocket</code></li>
<li>请求必须有一个<code>Connection</code>头字段，它的值必须是<code>Upgrade</code></li>
<li>请求必须有一个<code>Sec-WebSocket-key</code>头字段，他的值必须是一个噪音值，由16个字节随机数经过base64编码而成。每个连接的噪音必须是不同且随机的。</li>
<li></li>
<li>请求必须有一个<code>Sec-WebSocket-Version</code>头字段，它的值必须是<code>13</code></li>
</ol>
<h4 id="接下来看SocketRocket的实现："><a href="#接下来看SocketRocket的实现：" class="headerlink" title="接下来看SocketRocket的实现："></a>接下来看SocketRocket的实现：</h4><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div></pre></td><td class="code"><pre><div class="line">- (<span class="keyword">void</span>)didConnect;</div><div class="line">&#123;</div><div class="line">    SRFastLog(<span class="string">@"Connected"</span>);</div><div class="line">    <span class="built_in">CFHTTPMessageRef</span> request = <span class="built_in">CFHTTPMessageCreateRequest</span>(<span class="literal">NULL</span>, <span class="built_in">CFSTR</span>(<span class="string">"GET"</span>), (__bridge <span class="built_in">CFURLRef</span>)_url, kCFHTTPVersion1_1);</div><div class="line">    </div><div class="line">    <span class="comment">// Set host first so it defaults</span></div><div class="line">    <span class="built_in">CFHTTPMessageSetHeaderFieldValue</span>(request, <span class="built_in">CFSTR</span>(<span class="string">"Host"</span>), (__bridge <span class="built_in">CFStringRef</span>)(_url.port ? [<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"%@:%@"</span>, _url.host, _url.port] : _url.host));</div><div class="line">        </div><div class="line">    <span class="built_in">NSMutableData</span> *keyBytes = [[<span class="built_in">NSMutableData</span> alloc] initWithLength:<span class="number">16</span>];</div><div class="line">    SecRandomCopyBytes(kSecRandomDefault, keyBytes.length, keyBytes.mutableBytes);</div><div class="line">    </div><div class="line">    <span class="keyword">if</span> ([keyBytes respondsToSelector:<span class="keyword">@selector</span>(base64EncodedStringWithOptions:)]) &#123;</div><div class="line">        _secKey = [keyBytes base64EncodedStringWithOptions:<span class="number">0</span>];</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="meta">#pragma clang diagnostic push</span></div><div class="line"><span class="meta">#pragma clang diagnostic ignored <span class="meta-string">"-Wdeprecated-declarations"</span></span></div><div class="line">        _secKey = [keyBytes base64Encoding];</div><div class="line"><span class="meta">#pragma clang diagnostic pop</span></div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    assert([_secKey length] == <span class="number">24</span>);</div><div class="line"></div><div class="line">    <span class="comment">// Apply cookies if any have been provided</span></div><div class="line">    <span class="built_in">NSDictionary</span> * cookies = [<span class="built_in">NSHTTPCookie</span> requestHeaderFieldsWithCookies:[<span class="keyword">self</span> requestCookies]];</div><div class="line">    <span class="keyword">for</span> (<span class="built_in">NSString</span> * cookieKey <span class="keyword">in</span> cookies) &#123;</div><div class="line">        <span class="built_in">NSString</span> * cookieValue = [cookies objectForKey:cookieKey];</div><div class="line">        <span class="keyword">if</span> ([cookieKey length] &amp;&amp; [cookieValue length]) &#123;</div><div class="line">            <span class="built_in">CFHTTPMessageSetHeaderFieldValue</span>(request, (__bridge <span class="built_in">CFStringRef</span>)cookieKey, (__bridge <span class="built_in">CFStringRef</span>)cookieValue);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"> </div><div class="line">    <span class="comment">// set header for http basic auth</span></div><div class="line">    <span class="keyword">if</span> (_url.user.length &amp;&amp; _url.password.length) &#123;</div><div class="line">        <span class="built_in">NSData</span> *userAndPassword = [[<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"%@:%@"</span>, _url.user, _url.password] dataUsingEncoding:<span class="built_in">NSUTF8StringEncoding</span>];</div><div class="line">        <span class="built_in">NSString</span> *userAndPasswordBase64Encoded;</div><div class="line">        <span class="keyword">if</span> ([keyBytes respondsToSelector:<span class="keyword">@selector</span>(base64EncodedStringWithOptions:)]) &#123;</div><div class="line">            userAndPasswordBase64Encoded = [userAndPassword base64EncodedStringWithOptions:<span class="number">0</span>];</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="meta">#pragma clang diagnostic push</span></div><div class="line"><span class="meta">#pragma clang diagnostic ignored <span class="meta-string">"-Wdeprecated-declarations"</span></span></div><div class="line">            userAndPasswordBase64Encoded = [userAndPassword base64Encoding];</div><div class="line"><span class="meta">#pragma clang diagnostic pop</span></div><div class="line">        &#125;</div><div class="line">        _basicAuthorizationString = [<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"Basic %@"</span>, userAndPasswordBase64Encoded];</div><div class="line">        <span class="built_in">CFHTTPMessageSetHeaderFieldValue</span>(request, <span class="built_in">CFSTR</span>(<span class="string">"Authorization"</span>), (__bridge <span class="built_in">CFStringRef</span>)_basicAuthorizationString);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="built_in">CFHTTPMessageSetHeaderFieldValue</span>(request, <span class="built_in">CFSTR</span>(<span class="string">"Upgrade"</span>), <span class="built_in">CFSTR</span>(<span class="string">"websocket"</span>));</div><div class="line">    <span class="built_in">CFHTTPMessageSetHeaderFieldValue</span>(request, <span class="built_in">CFSTR</span>(<span class="string">"Connection"</span>), <span class="built_in">CFSTR</span>(<span class="string">"Upgrade"</span>));</div><div class="line">    <span class="built_in">CFHTTPMessageSetHeaderFieldValue</span>(request, <span class="built_in">CFSTR</span>(<span class="string">"Sec-WebSocket-Key"</span>), (__bridge <span class="built_in">CFStringRef</span>)_secKey);</div><div class="line">    <span class="built_in">CFHTTPMessageSetHeaderFieldValue</span>(request, <span class="built_in">CFSTR</span>(<span class="string">"Sec-WebSocket-Version"</span>), (__bridge <span class="built_in">CFStringRef</span>)[<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"%ld"</span>, (<span class="keyword">long</span>)_webSocketVersion]);</div><div class="line">    </div><div class="line">    <span class="built_in">CFHTTPMessageSetHeaderFieldValue</span>(request, <span class="built_in">CFSTR</span>(<span class="string">"Origin"</span>), (__bridge <span class="built_in">CFStringRef</span>)_url.SR_origin);</div><div class="line">    </div><div class="line">    <span class="keyword">if</span> (_requestedProtocols) &#123;</div><div class="line">        <span class="built_in">CFHTTPMessageSetHeaderFieldValue</span>(request, <span class="built_in">CFSTR</span>(<span class="string">"Sec-WebSocket-Protocol"</span>), (__bridge <span class="built_in">CFStringRef</span>)[_requestedProtocols componentsJoinedByString:<span class="string">@", "</span>]);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    [_urlRequest.allHTTPHeaderFields enumerateKeysAndObjectsUsingBlock:^(<span class="keyword">id</span> key, <span class="keyword">id</span> obj, <span class="built_in">BOOL</span> *stop) &#123;</div><div class="line">        <span class="built_in">CFHTTPMessageSetHeaderFieldValue</span>(request, (__bridge <span class="built_in">CFStringRef</span>)key, (__bridge <span class="built_in">CFStringRef</span>)obj);</div><div class="line">    &#125;];</div><div class="line">    </div><div class="line">    <span class="built_in">NSData</span> *message = <span class="built_in">CFBridgingRelease</span>(<span class="built_in">CFHTTPMessageCopySerializedMessage</span>(request));</div><div class="line">    </div><div class="line">    <span class="built_in">CFRelease</span>(request);</div><div class="line"></div><div class="line">    [<span class="keyword">self</span> _writeData:message];</div><div class="line">    [<span class="keyword">self</span> _readHTTPHeader];</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">- (<span class="built_in">BOOL</span>)_checkHandshake:(<span class="built_in">CFHTTPMessageRef</span>)httpMessage;</div><div class="line">&#123;</div><div class="line">    <span class="built_in">NSString</span> *acceptHeader = <span class="built_in">CFBridgingRelease</span>(<span class="built_in">CFHTTPMessageCopyHeaderFieldValue</span>(httpMessage, <span class="built_in">CFSTR</span>(<span class="string">"Sec-WebSocket-Accept"</span>)));</div><div class="line">    <span class="keyword">if</span> (acceptHeader == <span class="literal">nil</span>) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="literal">NO</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="built_in">NSString</span> *concattedString = [_secKey stringByAppendingString:SRWebSocketAppendToSecKeyString];</div><div class="line">    <span class="built_in">NSString</span> *expectedAccept = [concattedString stringBySHA1ThenBase64Encoding];</div><div class="line">    <span class="keyword">return</span> [acceptHeader isEqualToString:expectedAccept];</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>服务端返回的响应头中取<code>Sec-WebSocket-Accept</code>字段的值，如果为空，则握手失败。然后将客户端随机生成的key<code>_secKey</code>拼接上 258EAFA5-E914-47DA-95CA-C5AB0DC85B11 (该字符串固定)进行<code>SHA-1编码</code>后得到字节做<code>base64编码</code>得到字符串，与<code>Sec-WebSocket-Accept</code>字段的值比较，如果不同则握手失败。</p>
</div></article></div><div class="post-nav"><div class="prev-wrap col-md-6 col-xs-6"><i class="fa fa-angle-double-left"></i><a href="/2017/08/20/http-protocol/" class="prev-post">http_protocol</a></div></div></main></div><footer><div class="copyright"><p>© 2017 <i class="fa fa-heart"></i> SIMON</p></div></footer><script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script><script src="/js/bootstrap.min.js"></script><script src="//cdnjs.cloudflare.com/ajax/libs/fancybox/3.0.47/jquery.fancybox.min.js"></script><script src="/js/script.js"></script></body></html>